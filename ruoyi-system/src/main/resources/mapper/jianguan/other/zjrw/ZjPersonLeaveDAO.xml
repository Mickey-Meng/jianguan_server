<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.jianguan.common.dao.ZjPersonLeaveDAO">

    <resultMap id="BaseResultMap" type="com.ruoyi.common.core.domain.model.ZjPersonLeave">
        <id column="id" property="id" />
        <result column="leavePersonId" property="leavePersonId" />
        <result column="leaverPersonName" property="leaverPersonName" />
        <result column="leaverType" property="leaverType" />
        <result column="startTime" property="startTime" />
        <result column="endTime" property="endTime" />
        <result column="leaveDay" property="leaveDay" />
        <result column="handoffPersonId" property="handoffPersonId" />
        <result column="handoffPerson" property="handoffPerson" />
        <result column="leaveReason" property="leaveReason" />
        <result column="remark" property="remark" />
        <result column="status" property="status" />
        <result column="order" property="order" />
        <result column="processInstanceId" property="processInstanceId" />
        <result column="businessKey" property="businessKey" />
    </resultMap>

    <insert id="newPersonLeave" >
        insert into zj_person_leave (`leavePersonId`, `leaverPersonName`, `leaverType`, `subDate`, `startTime`, `endTime`,
        `leaveDay`, `handoffPersonId`, `handoffPerson`, `leaveReason`, `remark`, `status`, `order`, `processInstanceId`,
        `businessKey`)
        values (#{leavePersonId}, #{leaverPersonName}, #{leaverType}, #{subDate}, #{startTime}, #{endTime}, #{leaveDay},
         #{handoffPersonId}, #{handoffPerson}, #{leaveReason}, #{remark}, #{status}, #{order}, #{processInstanceId},
         #{businessKey});
    </insert>
    <select id="getByUserId" resultMap="BaseResultMap">
        select * from zj_person_leave where 1=1 and status != 1
        <if test='leavePersonId != null '> and leavePersonId = #{leavePersonId} </if>
        order by id desc
    </select>

    <update id="updatePersonLeave" parameterType="com.ruoyi.common.core.domain.model.ZjPersonLeave">
        update
            zj_person_leave
        <set>
            <if test="leavePersonId != null">
                leavePersonId = #{leavePersonId},
            </if>
            <if test="leaverPersonName != null">
                leaverPersonName = #{leaverPersonName},
            </if>
            <if test="leaverType != null">
                leaverType = #{leaverType},
            </if>
            <if test="subDate != null">
                subDate = #{subDate},
            </if>
            <if test="startTime != null">
                startTime = #{startTime},
            </if>
            <if test="endTime != null">
                endTime = #{endTime},
            </if>
            <if test="leaveDay != null">
                leaveDay = #{leaveDay},
            </if>
            <if test="handoffPersonId != null">
                handoffPersonId = #{handoffPersonId},
            </if>
            <if test="handoffPerson != null">
                handoffPerson = #{handoffPerson},
            </if>
            <if test="leaveReason != null">
                leaveReason = #{leaveReason},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
        </set>
        where processInstanceId = #{processInstanceId}
    </update>

    <select id="getAllByProjectId" resultMap="BaseResultMap">
        select
            a.*
        from zj_person_leave a
        <if test="roleType != null and roleType != ''">
            inner JOIN sys_user_role b ON a.leavePersonId = b.user_id
            inner JOIN sys_role c ON b.ROLE_ID = c.role_id
            inner JOIN sys_role d ON c.parent_id = d.role_id
            and d.role_id in (select role_id from sys_role where role_key = #{roleType})
        </if>
        order by a.subDate desc
    </select>

</mapper>
