<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.czjg.zjrw.dao.SsFUserOnlineDAO">
    <resultMap id="BaseResultMap" type="com.ruoyi.czjg.zjrw.domain.entity.SsFUserOnline">
        <id column="ID" jdbcType="INTEGER" property="id"/>
        <result column="USERNAME" jdbcType="VARCHAR" property="username"/>
        <result column="NAME" jdbcType="VARCHAR" property="name"/>
        <result column="role" jdbcType="INTEGER" property="role"/>
        <result column="updatetime" jdbcType="TIMESTAMP" property="updatetime"/>
    </resultMap>

    <insert id="insert">
   insert into ss_f_user_online (userid, username, name, role, updatetime)
    values (
    #{userid,jdbcType=INTEGER},
    #{username,jdbcType=VARCHAR},
    #{name,jdbcType=VARCHAR},
    #{role,jdbcType=INTEGER},
    now()
    )
 </insert>

    <update id="updateTimeByUserid">
        update ss_f_user_online set updatetime = now(), role = #{role}
        <if test="cid != null and cid != ''">
            , cid = #{cid}
        </if>
        <if test="lat != lat">
            lat = #{lat}
        </if>
        <if test="lon != lon">
            lon = #{lon}
        </if>
        where userid = #{userid}
    </update>

    <select id="getJLOnlineCount" resultType="integer">
      select
        count(a.id)
      from
        ss_f_user_online a
      left join ss_f_roles b on a.role = b.id
      left join ss_f_roles c on b.parentid = c.id
      left join ss_f_users d on a.userid = d.id
      where c.id =
        (select id from ss_f_roles
        where `name` = '监理集合' and `code` = 'jianlijihe')
       and a.updatetime &gt;= #{startTime} and a.updatetime &lt;= #{endTime}
       and a.role is not null
       and d.STSTATE = 1
    </select>

    <select id="getJLOnlineUsers" resultType="string">
        select
            a.name
         from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id =
        (select id from ss_f_roles where
          `name` = '监理集合' and `code` = 'jianlijihe')
        and a.updatetime &gt;= #{startTime} and a.updatetime &lt;= #{endTime}
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getAllJLUsers" resultType="string">
        select
            a.name
         from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id =
        (select id from ss_f_roles where
          `name` = '监理集合' and `code` = 'jianlijihe')
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getSGOnlineCount" resultType="integer">
      select
        count(a.id)
      from
        ss_f_user_online a
      left join ss_f_roles b on a.role = b.id
      left join ss_f_roles c on b.parentid = c.id
      left join ss_f_users d on a.userid = d.id
      where c.id =
        (select id from ss_f_roles
        where `name` = '施工集合' and `code` = 'shigongjihe')
      and a.updatetime &gt;= #{startTime}
      and a.updatetime &lt;= #{endTime}
      and a.role is not null
      and d.STSTATE = 1
  </select>

    <select id="getSGOnlineUsers" resultType="string">
        select
            a.name
        from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id =
        (select id from ss_f_roles where
          `name` = '施工集合' and `code` = 'shigongjihe')
        and a.updatetime &gt;= #{startTime}
        and a.updatetime &lt;= #{endTime}
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getAllSGUsers" resultType="string">
        select
            a.name
        from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id =
        (select id from ss_f_roles where
          `name` = '施工集合' and `code` = 'shigongjihe')
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getYZOnlineCount" resultType="integer">
      select
        count(a.id)
      from
        ss_f_user_online a
      left join ss_f_roles b on a.role = b.id
      left join ss_f_roles c on b.parentid = c.id
      left join ss_f_users d on a.userid = d.id
      where c.id in
        (select id from ss_f_roles where
          `name` in('全咨集合', '建设单位集合', '建设集团集合')
        and `code` in ('quanzijihe', 'jiashedanweijihe', 'jianshejituanjihe'))
      and a.updatetime &gt;= #{startTime}
      and a.updatetime &lt;= #{endTime}
      and a.role is not null
      and d.STSTATE = 1
  </select>

    <select id="getYZOnlineUsers" resultType="string">
        select
            a.name
        from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id in
        (select id from ss_f_roles where
          `name` in('全咨集合', '建设单位集合', '建设集团集合')
           and
          `code` in ('quanzijihe', 'jiashedanweijihe', 'jianshejituanjihe'))
        and a.updatetime &gt;= #{startTime}
        and a.updatetime &lt;= #{endTime}
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getAllYZUsers" resultType="string">
        select
            a.name
        from
            ss_f_user_online a
        left join ss_f_roles b on a.role = b.id
        left join ss_f_roles c on b.parentid = c.id
        left join ss_f_users d on a.userid = d.id
        where c.id in
        (select id from ss_f_roles where
          `name` in('全咨集合', '建设单位集合', '建设集团集合')
           and
          `code` in ('quanzijihe', 'jiashedanweijihe', 'jianshejituanjihe'))
        and a.role is not null
        and d.STSTATE = 1
    </select>

    <select id="getAllUserOnline" resultType="com.ruoyi.czjg.zjrw.domain.dto.UserOnlineDTO">
       select
            a.userid as userId,
            a.username as username,
            a.name as name,
            a.role as roleId,
            b.name as roleName,
            a.updatetime as updatetime
       from ss_f_user_online a left join ss_f_roles b on a.role = b.id;
    </select>

    <select id="getAllUserOnlineByTime" resultType="com.ruoyi.czjg.zjrw.domain.dto.UserOnlineDTO">
       select
            a.userid as userId,
            a.username as username,
            a.name as name,
            a.role as roleId,
            b.name as roleName,
            a.updatetime as updatetime
       from ss_f_user_online a left join ss_f_roles b on a.role = b.id
       where a.updatetime &gt;= #{startTime} and a.updatetime &lt;= #{endTime};
    </select>
</mapper>
